var stream;const enableLogger="false";let log=(...e)=>{JSON.parse(enableLogger)&&console.log("ff-cam Logs : ",...e)};function checkDeviceSupport(e){let a=[],i="https:"===location.protocol,o=!1;("undefined"!=typeof MediaStreamTrack&&"getSources"in MediaStreamTrack||navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)&&(o=!0);let s={isHTTPs:i,hasMicrophone:!1,hasSpeakers:!1,hasWebcam:!1,isMicrophoneAlreadyCaptured:false,isWebcamAlreadyCaptured:false,hasPermission:!1,availableTracks:{audio:[],video:[]},canEnumerate:!0,devices:{audio:!1,video:!1}};if(o){if(!navigator.enumerateDevices||!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return log("navigator.enumerateDevices not found"),s.canEnumerate=!1,void(e&&e(s));a=[],navigator.enumerateDevices((function(o){o.forEach((function(e){let o,n={};for(var r in e)n[r]=e[r];if("audio"===n.kind&&(n.kind="audioinput"),"video"===n.kind&&(n.kind="videoinput"),a.forEach((function(e){e.id===n.id&&e.kind===n.kind&&(o=!0)})),!o){if(n.deviceId||(n.deviceId=n.id),n.id||(n.id=n.deviceId),log("device",n),n.label){if(s.hasPermission=!0,"videoinput"===n.kind&&(s.isWebcamAlreadyCaptured=!0),"audioinput"===n.kind&&(s.isMicrophoneAlreadyCaptured=!0),"audioinput"===n.kind||"audio"===n.kind){let e={id:n.deviceId,type:"audio",name:n.label};s.availableTracks.audio.push(e)}if("videoinput"===n.kind||"video"===n.kind){let e={id:n.deviceId,type:"video",name:n.label};s.availableTracks.video.push(e)}"audioinput"!==n.kind&&"audio"!==n.kind||(s.devices.audio=!0),"videoinput"!==n.kind&&"video"!==n.kind||(s.devices.video=!0)}else n.label="Please invoke getUserMedia once.",s.hasPermission=!1,i||(n.label="HTTPs is required to get label of this "+n.kind+" device.",s.isHTTPs=!1),"audioinput"!==n.kind&&"audio"!==n.kind||(s.devices.audio=!0),"videoinput"!==n.kind&&"video"!==n.kind||(s.devices.video=!0);"audioinput"===n.kind&&(s.hasMicrophone=!0),"audiooutput"===n.kind&&(s.hasSpeakers=!0),"videoinput"===n.kind&&(s.hasWebcam=!0),a.push(n)}})),e&&e(s)}))}else log("canEnumerate is false")}!navigator.enumerateDevices&&window.MediaStreamTrack&&window.MediaStreamTrack.getSources&&(navigator.enumerateDevices=window.MediaStreamTrack.getSources.bind(window.MediaStreamTrack)),!navigator.enumerateDevices&&navigator.enumerateDevices&&(navigator.enumerateDevices=navigator.enumerateDevices.bind(navigator)),navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices&&(navigator.enumerateDevices=function(e){navigator.mediaDevices.enumerateDevices().then(e)}),log("FF_CAM LOADED"),sendMessage("ff-cam-iframe-loaded",{}),window.addEventListener("message",receiveMessage,!1);let getCameraMicPermission=e=>{let a={video:!1,audio:!1},i={video:!1,audio:!1},o=!0;if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return log("enumerateDevices() not supported."),void(o=!1);navigator.mediaDevices.enumerateDevices().then((function(o){o.forEach((function(e){log(e.kind+": "+e.label+" id = "+e.deviceId),"audio"!==e.kind&&"audioinput"!==e.kind||(a.audio=!0,e.label&&(i.audio=!0)),"video"!==e.kind&&"videoinput"!==e.kind||(a.video=!0,e.label&&(i.video=!0))}));let s={audio:!0,video:!0};a.audio&&i.audio&&(s.audio=!1,log("Audio Device Detected")),a.video&&i.video&&(s.video=!1,log("Video Device Detected")),a.audio||log("Audio Device Not Found"),a.video||log("Video Device Not Found"),e&&e(null,a.video&&i.video)})).catch((function(a){log("Enumerate Error"),log(a.name+": "+a.message),e&&e(a,!1)}))};function captureAudioAndVideo(e){getCameraMicPermission((function(a,i){!a&&i?stopStream(stream,(function(){navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then((function(a){stream=a,videoContainer(a),sendMessage(e?"cs_show_cam_recording":"cs_show_cam_only_recording")})).catch(e=>{log("Capture Audio and Video Error in iframe",e.message),sendMessage("cs_show_profile_pic",{})})})):sendMessage("cs_show_profile_pic",{})}))}let stopStream=(e,a)=>{e?(e.getTracks().forEach(e=>e.stop()),log("stop stream sucess ===",e=null),a&&a()):(log("stop stream fail ===",e=null),a&&a())},videoContainer=e=>{let a=document.querySelector("#vcc-ff-cam");a||(a=document.createElement("video"),a.style.display="block",a.id="vcc-ff-cam",a.style.height="100%",a.style.width="100%",a.style.objectFit="cover",document.body.appendChild(a)),"srcObject"in a?a.srcObject=e:window.webkitURL?window.webkitURL.createObjectURL(e):window.URL&&window.URL.createObjectURL&&window.URL.createObjectURL(e),setCanvasView()},setCanvasView=()=>{let e=document.querySelector("#vcc-ff-cam");e.onloadedmetadata=function(a){try{e.play(),sendMessage("video_loader_none")}catch(e){log("Video playback error")}},e.onerror=function(){log("Playing Error ===>"+e.error.code+"; details: "+e.error.message)}};function receiveMessage(e){if(e&&e.data&&e.data.hasOwnProperty("msg")&&log("Iframe rcv msg",e.data),e&&e.data){let a=e.data;if(a.hasOwnProperty("msg")&&a.msg)switch(a.msg){case"_fetch_media_devices_":navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then((function(e){log("Audio And Video both Allowed"),checkDeviceSupport(e=>{log("response.availableTracks",e.availableTracks),log("hasWebCam: ",e.hasWebcam,"<br>"),log("hasMicrophone: ",e.hasMicrophone,"<br>"),log("hasPermission: ",e.hasPermission,"<br>"),log("isHttps: ",e.isHTTPs,"<br>"),log("canEnumerate: ",e.canEnumerate,"<br>"),log("response.availableTracks",e.availableTracks),setDefaultAudioAndVideo(e.availableTracks),sendMessage("vcc_available_media",{availableTracks:e.availableTracks})})})).catch((function(e){log("navigator.mediaDevices.getUserMedia Error Audio Video not Allowed",e.message),log("Check for Video"),navigator.mediaDevices.getUserMedia({video:!0}).then((function(e){checkDeviceSupport(e=>{log("Video Permission allowed"),log("hasWebCam: ",e.hasWebcam,"<br>"),log("hasMicrophone: ",e.hasMicrophone,"<br>"),log("hasPermission: ",e.hasPermission,"<br>"),log("isHttps: ",e.isHTTPs,"<br>"),log("canEnumerate: ",e.canEnumerate,"<br>"),log("response.availableTracks",e.availableTracks),log("response.availableTracks",e.availableTracks),setDefaultAudioAndVideo(e.availableTracks),sendMessage("vcc_available_media",{availableTracks:e.availableTracks})})})).catch((function(e){log("Video Permission not allowed",e.message),log("Check for Audio"),navigator.mediaDevices.getUserMedia({audio:!0}).then((function(e){log("Audio Permission allowed"),log("hasWebCam: ",response.hasWebcam,"<br>"),log("hasMicrophone: ",response.hasMicrophone,"<br>"),log("hasPermission: ",response.hasPermission,"<br>"),log("isHttps: ",response.isHTTPs,"<br>"),log("canEnumerate: ",response.canEnumerate,"<br>"),log("response.availableTracks",response.availableTracks),checkDeviceSupport(e=>{log("response.availableTracks",e.availableTracks),setDefaultAudioAndVideo(e.availableTracks),sendMessage("vcc_available_media",{availableTracks:e.availableTracks})})})).catch((function(e){checkDeviceSupport(e=>{log("hasWebCam: ",e.hasWebcam,"<br>"),log("hasMicrophone: ",e.hasMicrophone,"<br>"),log("hasPermission: ",e.hasPermission,"<br>"),log("isHttps: ",e.isHTTPs,"<br>"),log("canEnumerate: ",e.canEnumerate,"<br>"),log("response.availableTracks",e.availableTracks),log("response.availableTracks",e.availableTracks),setDefaultAudioAndVideo(e.availableTracks),sendMessage("vcc_available_media",{availableTracks:e.availableTracks})})}))}))}));break;case"vcc_capture_media":localStorage.getItem("SELECTED_VIDEO_DEVICE")?captureAudioAndVideo(1):(stopStream(stream),sendMessage("cs_show_profile_pic",{}));break;case"vcc_cam_only_capture_media":captureAudioAndVideo(0);break;case"vcc_stop_stream":stopStream(stream)}}}function setDefaultAudioAndVideo(e){if(e&&e.hasOwnProperty("video")&&e.video.length>0){let a=e.video[0];localStorage.setItem("SELECTED_VIDEO_DEVICE",a.id)}else localStorage.setItem("SELECTED_VIDEO_DEVICE",null);if(e&&e.hasOwnProperty("audio")&&e.audio.length>0){let a=e.audio[0];localStorage.setItem("SELECTED_AUDIO_DEVICE",a.id)}else localStorage.setItem("SELECTED_AUDIO_DEVICE",null)}function sendMessage(e,a){let i={msg:e,...a};window.parent.postMessage(JSON.stringify(i),"*")}