var _gaq=_gaq||[],sentCounter=0,receivedCounter=0;let recorderChunks=[],sentChunksQueue=[];_gaq.push(["_setAccount","UA-157035625-1"]),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://ssl.google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();var tabOpenError=null;const bg=function(){let e="https://api.fluvid.com/api/v1",t="https://record.fluvid.com",r=null,n=!1;var o=0,a=0,i=0,c=null,s=!1,l=!1,d=!0,p=!1,u=null,g=0,m=0,_=null;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;var h,C={},v=null,b=!0,f=null,k=null,S=null,E=[],y={},T=[3,4,5,6,7,8,9,10];C.isLoggedIn=!1,C.flag=!1,C.recordingTime={h:0,m:0,s:0},C.supportedCodec=null;let H=()=>{let e=chrome.extension.getURL("images/icon16.png"),t="",r="";!C.mediaRecorderObj||"recording"!==C.mediaRecorderObj.state&&"paused"!==C.mediaRecorderObj.state?(clearInterval(h),t=""):p&&0!=p?(t="LIVE",r="red"):(t="REC",r="blue"),C.mediaRecorderObj&&"stop"===C.mediaRecorderObj.state&&(clearInterval(h),t=""),chrome.browserAction.setIcon({path:e}),chrome.browserAction.setBadgeText({text:t}),chrome.browserAction.setBadgeBackgroundColor({color:r})};H(),chrome.contextMenus.create({title:"Record Video (Alt+Shift+V)",contexts:["all"],id:"openExtention"}),chrome.contextMenus.onClicked.addListener((function(){_gaq.push(["_trackPageview"]),Helper.sendMsgToContentScript("vcc-open-extension-web",null,()=>{})})),chrome.commands.onCommand.addListener((function(e){_gaq.push(["_trackPageview"]),Helper.sendMsgToContentScript("vcc-open-extension-web",null,()=>{})}));let R,O=(e,t,r,n="basic")=>{chrome.notifications.create({type:n,title:e,message:t,iconUrl:chrome.extension.getURL("images/icon48.png")},()=>{r&&r()})};function w(){r&&r.readyState==r.OPEN&&r.send(""),o=setTimeout(w,2e3)}function I(){o&&clearTimeout(o)}chrome.notifications.onButtonClicked.addListener((function(e,t){e===R&&0===t&&window.open("https://fluvid.com/plans","_blank")}));let x=e=>{const t=Date.now();let r=null;do{r=Date.now()}while(r-t<e)},A=e=>{Helper.error("MediaRecorder Error from Helper",e.message)},M=(e=null)=>{if((!C.mediaRecorderObj||"inactive"===C.mediaRecorderObj.state||0==C.flag)&&e){C.supportedCodec=C.supportedCodec?C.supportedCodec:"video/webm;codecs=vp9";var t={audioBitsPerSecond:128e3,videoBitsPerSecond:25e5,mimeType:C.supportedCodec};C.mediaRecorderObj=new MediaRecorder(e,t)}C.mediaRecorderObj&&(C.mediaRecorderObj.onerror=A,C.mediaRecorderObj.onstop=function(e){Helper.error("Error in init Media Recorder method while stopping recording",e.message)})},L=()=>{c&&clearInterval(c)},j=()=>{var e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return!!(e&&"downlink"in e&&e.downlink>0&&navigator.onLine)},P=()=>{var e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=200;return e&&"downlink"in e&&(t=e.downlink>10?500:e.downlink>5?300:200),t},U=(e=1e3)=>{try{n=!0,e=P(),C.mediaRecorderObj&&"inactive"===C.mediaRecorderObj.state?(C.mediaRecording=!0,C.mediaRecorderObj.start(e)):C.mainStream?(C.mediaRecording=!0,C.mediaRecorderObj=null,M(C.mainStream),C.mediaRecorderObj.start(e)):Helper.error("Unable to start recording because MediaRecorder Object is not valid")}catch(e){Helper.error("Error while starting MediaRecorder from Helper",e.message)}},D=()=>{try{C.mediaRecorderObj?(C.mediaRecorderObj.pause(),H()):Helper.error("Unable to pause recording because MediaRecorder Object is not valid")}catch(e){Helper.error("Error while pausing MediaRecorder from Helper",e.message)}},q=()=>{try{C.mediaRecorderObj?(C.mediaRecorderObj.resume(),m=0,H()):Helper.error("Unable to resume recording because MediaRecorder Object is not valid")}catch(e){Helper.error("Error while resuming MediaRecorder from Helper",e.message)}},B=(e=1e4)=>{try{let e=JSON.parse(localStorage.getItem("live_user_profile")),a=localStorage.getItem("live_user_token");if((!p||e&&e.liveStream&&1==e.liveStream.recording&&p)&&a&&k!=u){k=u;let e="https://fluvid.com/videos/detail/"+u;window.open(e+"?loading="+u,"_blank"),Helper.setPopupSetting({popupType:"open_0",popupStatus:!1});let t=chrome.extension.getURL("images/icon16.png");chrome.browserAction.setIcon({path:t}),chrome.browserAction.setBadgeText({text:""}),N(e),O("Video link copied to clipboard","Paste the link to share/view your video.")}else Helper.sendMsgToContentScript("streamStopOpenPopup",null,()=>{});if(n=!1,!C.flag)return;C.flag=!1;let c=chrome.extension.getURL("images/icon16.png");chrome.browserAction.setIcon({path:c}),chrome.browserAction.setBadgeText({text:""});let s=0,l=setInterval(()=>{$(),s++,(recorderChunks&&0===recorderChunks.length||s>900)&&clearInterval(l)},1e3);C.mediaRecording=!1,C.mediaRecorderObj&&"inactive"===C.mediaRecorderObj.state&&C.mediaRecorderObj.stop(),C.mediaRecorderObj=null;var t=0,o=!1;g=0;let d=setInterval((function(){++i%25==0&&900!=i&&O("Network Trouble","Please wait. Your video is still under processing."),r&&r.readyState==r.OPEN&&receivedCounter>=sentCounter?(X().then(e=>{e&&e.videoId?(g=1,K()):Helper.error("Redirection issue after stop recording",e),V(),C.flag=!1,C.mediaRecording=!1,setTimeout(()=>{r=null},1e3),H()}).catch(e=>{g=2,r=null,K(),Helper.error("Error While Stopping Recording on Streaming Server",e.message)}),clearInterval(d)):r&&r.readyState==r.OPEN&&t<receivedCounter?(t=receivedCounter,i=0,o||(o=!0,O("Slow Connection","Please check your internet connection."))):i>900||i>900&&(!r||r.readyState!=r.OPEN)?(g=2,clearInterval(d),K(),O("Something Went Wrong","Server is unreachable. Please check your internet connection.")):i%60==0&&900!=i&&(O("Connection Error","Please check your internet connection. Connect back to avoid any video processing errors."),g=2,K(),clearInterval(d))}),1e3);C.mainStream?(C.mainStream.getTracks().forEach(e=>e.stop()),b&&f.getTracks().forEach(e=>e.stop())):Helper.error("Unable to stop singletonObj.mainStream"),m=0,Helper.broadcastToAllTabs("ping",{},()=>{})}catch(e){Helper.error("Error while stoping MediaRecorder from Helper",e.message)}finally{Helper.setKeyValue("activeTab",null),Helper.setKeyValue("activeWindow",null),L()}},N=e=>{var t=document.createElement("input");t.style="position: absolute; left: -1000px; top: -1000px",t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)},V=()=>{r&&r.readyState==r.OPEN?r.close():(r=null,Helper.error("unable to close websocket connection"))},K=()=>{let e=chrome.extension.getURL("images/icon16.png");chrome.browserAction.setIcon({path:e}),chrome.browserAction.setBadgeText({text:""})},G=()=>{let e=localStorage.getItem("gmail-login");d&&"1"!=e?(_gaq.push(["_trackPageview"]),Helper.sendMsgToContentScript("cs_open_action_btn",{receivedCounter:receivedCounter,sentCounter:sentCounter},()=>{})):d=!0,F()},F=()=>{Server.performHttpRequest("GET","https://api.fluvid.com/api/v1/auth/verifyToken",null,null).then(e=>{if(e&&"200"==e.statusCode){C.isLoggedIn=!0;let t=e.data.userInfo.plan_type;Helper.sendMsgToMain("logged_in",{profileData:e.data.userInfo,recordingStatus:C.flag},()=>{}),localStorage.setItem("live_user_profile",JSON.stringify(e.data.userInfo)),Helper.setChrUserProfile(e.data.userInfo),J(t),Q()}else!e||2016!=e.statusCode&&2017!=e.statusCode&&2018!=e.statusCode&&2019!=e.statusCode||(C.isLoggedIn=!1,Helper.sendMsgToMain("logged_out",{error:e.message},()=>{}),window.localStorage.removeItem("live_user_profile"),window.localStorage.removeItem("live_user_token"))}).catch(e=>{C.isLoggedIn=!1,Helper.sendMsgToMain("logged_out",{error:e.message},()=>{})}).finally(()=>{})},W=()=>{chrome.tabs.query({currentWindow:!0,active:!0},(function(e){if(e&&e.length>0){var t=new URL(e[0].url).hostname;t=t.indexOf("www.")>-1?t.replace("www.",""):t,E.indexOf(t)>-1&&(Helper.sendMsgToContentScript("cs_pause_ott_platform",null,()=>{}),O("Recording Interrupted","The recording is prohibited on this website to protect copyrights. Navigate to another website and resume recording."))}}))},J=e=>{(async function(){let e=await fetch("https://api.fluvid.com/api/v1/pricing/planFeature",{method:"GET",headers:{"Content-Type":"application/json"}});return await e.json()})().then(t=>{v=t.data.planFeature.PlansDetails[e],Helper.sendMsgToContentScript("bg_plan_details",{plans:v},()=>{}),Helper.sendMsgToMain("bg_plan_details_for_main",{plans:v},()=>{}),Server.performHttpRequest("GET","https://api.fluvid.com/api/v1/ott",null,null).then(e=>{e&&"200"==e.statusCode&&(E=e.data.ott,W())}).catch(e=>{console.log("Not list of ott platforms")})}).catch(e=>{console.log(e,"<===Getting err into plans")})},Q=()=>{let e=localStorage.getItem("live_user_token");body={token:e},Server.performHttpRequest("GET","https://api.fluvid.com/api/v1/setting/integration/list",body,null).then(e=>{e&&"200"==e.statusCode&&e.data&&e.data.integrationSetting?Helper.setAppIntegrations(e.data.integrationSetting):Helper.setAppIntegrations(null)})},z=e=>new Promise((n,o)=>{C.flag||o("Recording Stopped by User");var a=["video/webm;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8"];for(var i in a)if(MediaRecorder.isTypeSupported(a[i])){C.supportedCodec=a[i];break}C.supportedCodec||(C.supportedCodec="video/webm;codecs=vp9"),s=!1;let c=localStorage.getItem("live_user_token"),l=JSON.parse(localStorage.getItem("force_start")),d={};_&&_.stream_name&&1==p?(d={token:c,title:e,codec:C.supportedCodec.split("=")[1],broadcast:p,stream_name:_.stream_name,stream_type:_.type,force_start:l||!1},T.indexOf(_.type)>-1?Helper.sendMsgToContentScript("socialStream",{status:!0}):Helper.sendMsgToContentScript("socialStream",{status:!1})):(d={token:c,title:e,codec:C.supportedCodec.split("=")[1],broadcast:p,force_start:l||!1},Helper.sendMsgToContentScript("socialStream",{status:!1}));let g={...d,...y};V(),Server.performHttpRequest("POST",t+"/start_recording",g,null,!1).then(e=>{if(e.status)receivedCounter=0,sentCounter=0,Server.getSocketConnection().then(t=>{r=t,u=e.data.videoId,r&&r.readyState==r.OPEN?(w(),r.onmessage=function(e){if(e.data){let t=JSON.parse(e.data);t.hasOwnProperty("ack")&&(receivedCounter=t.ack,sentChunksQueue&&sentChunksQueue.length>0&&sentChunksQueue.shift())}},r.onerror=function(){sentCounter=receivedCounter,recorderChunks=sentChunksQueue.concat(recorderChunks),sentChunksQueue=[],I()},r.onopen=function(){Helper.log("WebSocket connection established in bg")},r.onclose=function(){Helper.log("WebSocket connection closed in bg"),sentCounter=receivedCounter,recorderChunks=sentChunksQueue.concat(recorderChunks),sentChunksQueue=[],I()},n("200")):(Helper.error("Socket Connection not Proper"),o(new Error("Socket Connection not Proper")))}).catch(e=>{Helper.error("Socket Connection Failed",e.message),o(e)}),localStorage.removeItem("force_start");else if("prev_record_in_progress"==e.code){confirm("Are you sure you want to start a new stream, while one of your stream is already playing.")?(localStorage.setItem("force_start",!0),oe("fStart"),Helper.sendMsgToContentScript("bg-force-start-recording",null,()=>{})):(localStorage.removeItem("force_start"),o(new Error("Forcefully video not start yet : "+JSON.stringify(e))))}else o(new Error("Start Recording API Status Issue "+JSON.stringify(e))),Helper.error("Start Recording Request Issue"),localStorage.removeItem("force_start")}).catch(e=>{console.log("Authorization Error",e.message),o(e),localStorage.removeItem("force_start")})}),Y=()=>{Helper.getAdvanceSetting("advanceSettingStatus").then(e=>{let t=e.advanceSettingStatus;t.camFrameBottom="20px",t.camFrameLeft="100px",t.menuFrameTop="144px",t.menuFrameLeft="0px",t.camZoom=1,t.toolMenu="close",t.penMenuOption="close",t.canvasTool="enableClick",t.recordingStart=!1,Helper.setAdvanceSetting(t),Helper.log(t,"<===data for console lososs")}).catch(e=>{console.error("Cam frame move "+e)})};let X=()=>(clearInterval(h),new Promise((e,r)=>{let n=localStorage.getItem("live_user_token"),o={recording_duration:(a=+C.recordingTime.h,i=+C.recordingTime.m,c=+C.recordingTime.s,1e3*(60*a*60+60*i+c)),token:n};var a,i,c;fetch(t+"/stop_recording",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(o)}).then(t=>{t.status?t.json().then(t=>{t&&t.videoId&&(sentCounter=receivedCounter,g=1,V()),e(t)}):r(new Error("Server Status Not Positive"))}).catch(e=>{g=2,r(e)})})),Z=()=>{if(receivedCounter=0,sentCounter=0,s=!0,(()=>{Y();try{C.mediaRecorderObj?C.mediaRecorderObj.stop():Helper.error("Unable to stop recording because MediaRecorder Object is not valid",C.mediaRecorderObj),C&&C.mainStream&&C.mainStream.getTracks().forEach(e=>e.stop()),b&&f&&f.getTracks().forEach(e=>e.stop()),V(),setTimeout(()=>{r=null,C.mediaRecorderObj=null,C.mainStream=null},1e3),recorderChunks=[],C.mediaRecording=!1,C.flag=!1,Helper.setKeyValue("activeTab",null),Helper.setKeyValue("activeWindow",null),m=0,Helper.broadcastToAllTabs("ping",{},()=>{})}catch(e){Helper.error("Error while canceling MediaRecorder from Helper",e.message),r=null,C.mediaRecorderObj=null,C.mainStream=null,C.mediaRecording=!1,C.flag=!1,Helper.setKeyValue("activeTab",null),Helper.setKeyValue("activeWindow",null),m=0,Helper.broadcastToAllTabs("ping",{},()=>{})}finally{L(),H()}clearInterval(h),Helper.getEventActionObj("eventActionObj").then(e=>{(y=e.eventActionObj).hasOwnProperty("microphone_enabled")&&(y.microphone_enabled="1"),y.hasOwnProperty("initiator")&&delete y.initiator,Helper.setEventActionObj(y)})})(),+C.recordingTime.h>0||+C.recordingTime.m>0||+C.recordingTime.s>0){let e=localStorage.getItem("live_user_token");fetch(t+"/cancel_recording",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({token:e})}).then(e=>{})}},$=()=>{if(recorderChunks&&recorderChunks.length>0&&!l){if(l=!0,r&&r.readyState==r.OPEN)for(;recorderChunks.length>0&&r&&r.readyState==r.OPEN;){let e=recorderChunks.shift();r.send(e),sentChunksQueue.push(e),sentCounter++}else s||ee().then(e=>{$()}).catch(e=>{Helper.error("Socket Connection Failed but collected While Uploading",r)});l=!1}},ee=()=>new Promise((e,t)=>{s=!0,j()?(x(2e3),$()):a>300?(s=!1,O("Connection Error","You recording is not completed due to internet problem."),recorderChunks=[],sentChunksQueue=[],t(!1)):(1!=a&&a%20!=0||j()||300==a||O("Connection Error","Please check your internet connection. Connect back to avoid any video processing errors."),x(3e3),$(),a++),j()?Server.getSocketConnection().then(n=>{r=n,r&&r.readyState==r.OPEN?(e(!0),s=!1,w(),r.onmessage=function(e){if(e.data){let t=JSON.parse(e.data);t.hasOwnProperty("ack")&&(receivedCounter=t.ack,sentChunksQueue&&sentChunksQueue.length>0&&sentChunksQueue.shift())}},r.onerror=function(){I(),sentCounter=receivedCounter,recorderChunks=sentChunksQueue.concat(recorderChunks),sentChunksQueue=[],V()},r.onopen=function(){a=0},r.onclose=function(){Helper.log("WebSocket connection closed in bg"),I(),sentCounter=receivedCounter,recorderChunks=sentChunksQueue.concat(recorderChunks),sentChunksQueue=[]}):(t(!1),s=!1,Helper.error("Socket Connection not Proper in ReConnecting"))}).catch(e=>{t(!1),s=!1,Helper.error("Socket Connection Failed in ReConnecting",e.message)}):s=!1}),te=e=>{sentCounter=0,receivedCounter=0,recorderChunks=[],sentChunksQueue=[],a=0,s=!1,l=!1;try{Helper.log("Media Recording start"),C.mediaRecorderObj=null,M(e);let t=P();C.mediaRecorderObj.start(t),C.mediaRecording=!0,Helper.setMediaRecording="recording",C.recordingTime={h:0,m:0,s:-1},L(),c=setInterval((function(){C.mediaRecorderObj&&"recording"==C.mediaRecorderObj.state&&(C.recordingTime.s++,60===C.recordingTime.s&&(C.recordingTime.s=0,C.recordingTime.m++,60===C.recordingTime.m&&(C.recordingTime.m=0,C.recordingTime.h++))),Helper.getRecordingStatus().then(e=>{"start"===e.recordingStatus||"resume"===e.recordingStatus?(0!==m&&m%30!=0||W(),m++):m=0}),Helper.broadcastToAllTabs("updateTimer",{},()=>{})}),1e3),H();C.mediaRecorderObj.ondataavailable=function(e){1,recorderChunks.push(e.data),$()},C.mediaRecorderObj.onerror=function(e){Helper.error("Error while recording stream",e.message)}}catch(e){Helper.error("Error while recording stream in catch",e.message)}},re=()=>{Helper.log("Recording Status Set to Start"),C.mainStream&&(C.mainStream.getVideoTracks()[0].onended=function(){let e={},t=0;if(e.recordingWindowId=Helper.getKeyValue("activeWindow"),e.recordingTabId=Helper.getKeyValue("activeTab"),"null"!=e.recordingWindowId&&(t=Helper.parseJSON(e.recordingWindowId),t=t?t.windowId:0),"null"!=e.recordingTabId){let r=Helper.parseJSON(e.recordingTabId);r&&(recordingTabId=r.tabId||0,t=r.windowId||0)}let r=!1;chrome.tabs.query({url:["http://*/*","https://*/*"]},(function(e){e.forEach((function(e){t&&t==e.windowId&&(r=!0,Helper.broadcastToAllTabs("popup_stop_recording",{},()=>{})),Helper.log(e)}))})),C.recordingTime.h>=1||C.recordingTime.m>=1||C.recordingTime.s>=1?B():Helper.sendMsgToContentScript("bg_cancel_recording",null,()=>{}),C.recordingTime={h:0,m:0,s:0}})},ne=(e,t)=>navigator.mediaDevices.getUserMedia(e),oe=(e=null)=>{C.flag=!1,H(),C.mediaRecording=!1,Helper.setKeyValue("activeTab",null),Helper.setKeyValue("activeWindow",null),L(),"fStart"!=e&&Helper.broadcastToAllTabs("popup_cancel_recording",ie(),()=>{})},ae=(e,t,r)=>{if(C.flag)return Helper.log("Recording is already running"),!1;let n=null;C.mainStream=null,C.mediaConstraints=e,C.recordingType=r,C.flag=!0,H();let o=Helper.getKeyValue("SELECTED_AUDIO_DEVICE"),a=Helper.getKeyValue("SELECTED_VIDEO_DEVICE");o||Helper.error("Audio Device Not Accessible or Present"),a||Helper.error("Video Device Not Accessible or Present"),Helper.setKeyValue("activeTab",null),Helper.setKeyValue("activeWindow",null),e.screen?e.fullDesktop?new Promise((e,t)=>{chrome.desktopCapture.chooseDesktopMedia(["screen","window","tab","audio"],null,(function(r){r||(Helper.setKeyValue("activeWindow",null),t("User denied this action.")),Helper.getCurrentTabInfo().then(t=>{Helper.setKeyValue("activeWindow",JSON.stringify({windowId:t.windowId})),e(r)}).catch(e=>{Helper.error("Current tab info not detected"),alert("Current Tab Id Not Detected"),Helper.setKeyValue("activeWindow",null),t("Current tab info not detected")})}))}).then(r=>{z(t).then(t=>{"200"==t?(n={audio:!!b&&{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,echoCancellation:!0}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,minFrameRate:S||30,maxWidth:1280,maxHeight:720},optional:[]}},Helper.log("constraints",n),ne(n).then(t=>{a=Helper.getKeyValue("SELECTED_AUDIO_DEVICE"),n={audio:!1},e.audio&&o&&(n.audio={deviceId:o,autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0}),n.audio?ne(n).then(e=>{let r=new MediaStream,n=ce([e,t]);(b&&n?n:e).getAudioTracks().forEach((function(e){b?r.addTrack(e):t.addTrack(e)})),b&&(f=t,t.getVideoTracks().forEach((function(e){r.addTrack(e)}))),C.mainStream=b?r:t,re(),Helper.sendMsgToContentScript("cs_start_recording_timer",null,()=>{})}).catch(e=>{Helper.error("Error while capturing desktop audio in taskManager method ",e.message),C.mainStream=t,re(),Helper.sendMsgToContentScript("cs_start_recording_timer",null,()=>{})}):(C.mainStream=t,re(),Helper.sendMsgToContentScript("cs_start_recording_timer",null,()=>{}))}).catch(e=>{Helper.error("Error while capturing desktop in taskManager method ",e.message),oe(e)})):(O("Connection failed please try again."),oe("socket is not connected"))}).catch(e=>{O("Connection failed please try again."),Helper.error("Error in taskManager method during authorizing user",e.message),oe(e)})}).catch(e=>{O("Connection failed please try again."),Helper.error("Error while accessing Desktop in taskManager method ",e.message),oe(e)}):new Promise((e,t)=>{let r={audio:!0,video:!0,videoConstraints:{mandatory:{chromeMediaSource:"tab",maxWidth:1280,maxHeight:720,minFrameRate:S||30,maxAspectRatio:1.777777778}}};r.audioConstraints=!0===b?{mandatory:{chromeMediaSource:"desktop",echoCancellation:!0}}:{mandatory:{echoCancellation:!0}},chrome.tabCapture.capture(r,(function(r){r||(Helper.setKeyValue("activeTab",null),alert("User denied this action."),t("User denied this action.")),Helper.getCurrentTabInfo().then(t=>{Helper.setKeyValue("activeTab",JSON.stringify({tabId:t.id,windowId:t.windowId})),e(r,t)}).catch(e=>{Helper.error("Current tab info not detected"),alert("Current Tab Id Not Detected"),t("Current tab info not detected")});let n=new Audio;n.srcObject=r,n.play()}))}).then((r,a)=>{z(t).then(t=>{"200"==t?(n={audio:!1},Helper.log("selectedAudioDevice & mediaConstraints",e,o),e.audio&&o&&(n.audio={deviceId:o,autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0}),n.audio?ne(n).then(e=>{let t=new MediaStream,n=ce([e,r]);(b&&n?n:e).getAudioTracks().forEach((function(e){b?t.addTrack(e):r.addTrack(e)})),b&&r.getVideoTracks().forEach((function(e){t.addTrack(e)})),C.mainStream=1==b?t:r,re(),Helper.sendMsgToContentScript("cs_start_recording_timer",null,()=>{})}).catch(e=>{Helper.error("Error while capturing tab audio in taskManager method ",e.message),C.mainStream=r,re(),Helper.sendMsgToContentScript("cs_start_recording_timer",null,()=>{})}):(C.mainStream=r,re(),Helper.sendMsgToContentScript("cs_start_recording_timer",null,()=>{}))):(O("Connection failed please try again."),oe())}).catch(e=>{Helper.error("Error in taskManager method during authorizing user",e.message),oe(e)})}).catch(e=>{Helper.error("Error while capturing tab in taskManager method ",e.message),oe(e)}):e.video&&(n={audio:!1,video:!1},e.audio&&o&&(n.audio={deviceId:o,autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0}),e.video&&a&&(n.video={deviceId:a}),n.video&&z(t).then(e=>{"200"==e?ne(n).then(e=>{C.mainStream=e,re(),Helper.getCrossStatus().then(e=>{e.crossStatus&&"3"!=e.crossStatus.camraFrameType&&Helper.sendMsgToContentScript("cs_start_recording_timer",null,()=>{})})}).catch(e=>{Helper.error("Error while capturing video in taskManager method ",e.message),oe(e)}):(O("Connection failed please try again."),oe("socket is not connected"))}).catch(e=>{Helper.error("Error in taskManager method during authorizing user",e.message),O("Connection failed please try again."),oe(e)}))},ie=(e={tab:0})=>{let t=Helper.getKeyValue("activeWindow"),r=Helper.getKeyValue("activeTab"),n="inactive";return C.mediaRecorderObj&&C.mediaRecorderObj.state&&(n=C.mediaRecorderObj.state),"inactive"==n&&L(),{tab:e.tab,recordingTabId:r,recordingWindowId:t,isLoggedIn:C.isLoggedIn,recordingStatus:C.flag,recordingType:C.recordingType,constraints:C.mediaConstraints,recordingTime:C.recordingTime,mediaRecorderState:n}};function ce(e){var t=new AudioContext,r=[],n=t.createGain();n.connect(t.destination),n.gain.value=0;var o=0;if(e.forEach((function(e){if(e.getAudioTracks().length){o++;var a=t.createMediaStreamSource(e);a.connect(n),r.push(a)}})),o)return audioDestination=t.createMediaStreamDestination(),r.forEach((function(e){e.connect(audioDestination)})),audioDestination.stream}let se=(t,r)=>{if(t){let n;n="fb"===r?e+"/auth/login/facebook?authToken="+t:"ot"===r?e+"/auth/login/microsoft?authToken="+t:"ap"===r?e+"/auth/login/apple?authToken="+t:e+"/auth/login/google?authToken="+t,Server.performHttpRequest("GET",n,null,null,!1).then(e=>{if(e&&200===e.statusCode&&e.data.twofa_enable)Helper.sendMsgToContentScript("fde-2f-login-token",{data:e.data},()=>{}),Helper.sendMsgToMain("fde-2f-login-token",{data:e.data},()=>{});else if(e&&200===e.statusCode&&!e.data.twofa_enable){let t=e.data.userProfile||null,r=e.data.userToken||null;if(t){Helper.setKeyValue("live_user_profile",JSON.stringify(t));let e=null;t&&t.hasOwnProperty("profile_pic")&&t.profile_pic&&(e=t.profile_pic),Helper.setUserImage(e)}r&&(localStorage.setItem("live_user_token",r),C.isLoggedIn=!0,Helper.sendMsgToContentScript("cs_cross_product_login",{token:r,profile:t},()=>{}),Helper.sendMsgToExtensionFile("ext_cross_product_login",{token:r,profile:t},()=>{})),le()}else Helper.sendMsgToExtensionFile("ext_cross_login_error",e);e&&200===e.statusCode&&e.data.firstTimeLogin&&window.open("https://fluvid.com/welcome?utm_source=fluvid&utm_medium=extension&utm_campaign=install","_blank")})}else Helper.error("Empty Auth Code Received")};chrome.runtime.onMessage.addListener((e,t,r)=>{if(Helper.log(e,"from the extension"),(e=>{Helper.log("Background Script Received Message ===> "+e.type)})(e),"load_video_iframe"===e.type&&Helper.sendMsgToContentScript("bg_plan_details",{plans:v},()=>{}),"main_init_recording"===e.type&&Helper.getEventActionObj("eventActionObj").then(e=>{(y=e.eventActionObj).version=chrome.runtime.getManifest().version,y.hasOwnProperty("microphone_enabled")||(y.microphone_enabled="1"),y.hasOwnProperty("recording_mode")||(y.recording_mode="SC"),Helper.getAdvanceSetting("advanceSettingStatus").then(e=>{e&&e.advanceSettingStatus&&(advanceOptionsObj=e.advanceSettingStatus,y.system_sound_enabled=Number(advanceOptionsObj.systemSound).toString())})}).catch(e=>{console.log(e,"<===Error from Event Action Obj Background error"),y={}}),"fde_chunk_data"===e.type){let e=setInterval(()=>{Helper.sendMsgToMain("fde_chunk_upload",{receivedCounter:receivedCounter,sentCounter:sentCounter},()=>{}),receivedCounter==sentCounter&&clearInterval(e)},1e3)}if("ping_background_js"===e.type&&(m=0,Helper.broadcastToAllTabs("ping",{},()=>{})),"get_current_tab_info"===e.type){return Helper.log("get_current_tab_info called",e,t),void r(ie(t))}if("bg_set_onLive_recording"===e.type?(_gaq.push(["_trackEvent","Chrome Extension","Live Stream Btn Clicked"]),p=!0):"bg_set_offLive_recording"===e.type&&(p=!1,e.autoClick||_gaq.push(["_trackEvent","Chrome Extension","Screen Recording Btn Clicked"])),"bg_set_system_sound"===e.type&&(b=JSON.parse(e.systemSound)),"bg_click_screen_cam"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Screen + Cam Btn Clicked"]),"bg_click_Cam_only"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Cam Only Btn Clicked"]),"bg_click_screen_only"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Screen Only Btn Clicked"]),"bg_click_full_desktop"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Full Desktop Btn Clicked"]),"bg_click_current_tab"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Current Tab Btn Clicked"]),"bg_change_audio_option"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Audio Option Change"]),"bg_change_video_option"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Video Option Change"]),"bg_click_recording_timer"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Recording Timer Click"]),"bg_click_countdown"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","countdown Btn Click"]),"bg_click_countdown_change"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","countdown Option Change"]),"bg_click_mouse_option"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Mouse Option Btn Click"]),"bg_click_drawing_mouse_tools"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Drawing Tools Btn Click"]),"bg_click_reset_default"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Reset Default Btn Click"]),"bg_click_Keyboard_open"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Keyboard Open Btn Click"]),"bg_click_Keyboard_close"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Keyboard Close Btn Click"]),"bg_click_advance_setting_open"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Advance Setting Open Btn Click"]),"bg_click_advance_setting_close"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Advance Setting Close Btn Click"]),"bg_click_start_recording"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Start Recording Btn Click"]),"bg_click_copy_clipboard_ext"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","copy clicpboard 1 Btn Click"]),"bg_change_mic_btn"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Mic on/off Btn Click"]),"vcc_click_pen_main"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Pen Main Btn Click"]),"vcc_click_pen_edit"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Pen Edit Btn Click"]),"vcc_click_pen_thikness"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Pen Thikness Btn Click"]),"vcc_click_pen_color"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","pen Color Btn Click"]),"vcc_click_eraser"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","eraser Btn Click"]),"vcc_click_highlighter"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Highlighter Btn Click"]),"vcc_click_focus"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Focus Mouse Btn Click"]),"vcc_click_paint_clean"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Paint Clean Btn Click"]),"vcc_click_start_btn_cam"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","start Recording Video frame Btn Click"]),"vcc_click_stop"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Stop Recording Btn Click"]),"vcc_click_pause"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","pause Recording Btn Click"]),"vcc_click_resume"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Resume Recording Btn Click"]),"vcc_click_hide_menu"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Hide Menu Btn Click"]),"vcc_click_hide_cam"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Show Menu Btn Click"]),"vcc_click_show_cam"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Show Cam Btn Click"]),"vcc_click_flip_video"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Flip Video Btn Click"]),"vcc_click_cancel_recording"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Cancel Recording Btn Click"]),"vcc_cam_small"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Cam Small Btn Click"]),"vcc_cam_medium"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Cam Medium Btn Click"]),"vcc_cam_large"===e.type&&_gaq.push(["_trackEvent","Chrome Extension","Cam Large Btn Click"]),"stream_bg_id"===e.type&&(_=e.singleStreamData,_gaq.push(["_trackEvent","Chrome Extension","Stream Option Change"])),e.msg,"taskManager"===e.type&&ae(e.mediaConstraints),e.type,"bg_start_media_recording"===e.type&&(te(C.mainStream),Helper.sendMsgToContentScript("bg_plan_details",{plans:v},()=>{})),"bg_init_recording"===e.type&&U(e.time),"bg_stop_recording"===e.type&&B(e.timer),"bg_cancel_recording"===e.type&&Z(),"bg_pause_recording"===e.type&&D(),"bg_resume_recording"===e.type&&q(),"is_user_logged_in"===e.type&&G(),"bg_apple_login"===e.type&&e&&e.envRsp&&"apple"==e.envRsp.state){let t=e.envRsp;t&&"apple"==t.state&&t.q.indexOf("login/apple/callback")>-1&&se(t.code,"ap")}if("is_user_logged_for_gmail"===e.type&&F(),"fde_timer_start"===e.type){let e=60*(+v.fde_video_count_limit-+v.fde_popup_breakups)-1;a=e,h=setInterval(()=>{n=parseInt(a/60,10),o=parseInt(a%60,10),n=n<10?"0"+n:n,o=o<10?"0"+o:o,Helper.sendMsgToContentScript("fde_timer_set",{timerData:n+":"+o},()=>{}),--a<0&&clearInterval(h)},1e3)}var n,o,a;"fde_tab_changes_message"===e.type&&(1!=e.status||tabOpenError?0==e.status&&(tabOpenError=!1):(tabOpenError=!0,O("Recording a background tab","Fluvid is recording another chrome tab in the background."))),"pause_notification"===e.type&&((e,t,r,n="basic")=>{chrome.notifications.create({type:n,title:e,message:t,iconUrl:chrome.extension.getURL("images/icon48.png"),buttons:[{title:"Upgrade plan"}]},(function(e){R=e}))})("Recording Paused!","You have reached maximum 1-hour recording limit for basic plan. Upgrade plan to have unrestricted access."),"logout_user"===e.type&&(localStorage.clear(),chrome.storage.sync.clear((function(e){Helper.log("cleared")})),chrome.storage.local.clear((function(e){Helper.log("cleared")})),B(),C.mediaRecorderObj=null,C.mainStream=null,Helper.sendMsgToMain("logged_out",{error:"logout"},()=>{})),"vcc_open_fluvid_popup"===e.type&&de()}),chrome.tabs.onCreated.addListener((function(e){m=0,Helper.broadcastToAllTabs("ping",{},()=>{})})),chrome.tabs.onActivated.addListener((function(e){setTimeout(()=>{m=0,Helper.sendMsgToContentScript("bg_plan_details",{plans:v},()=>{}),Helper.sendMsgToContentScript("bg_tab_change",{data:1},()=>{}),C.flag&&Helper.getCurrentTabInfo().then(e=>{if(e&&e.url&&(e.url.indexOf("http://")>-1||e.url.indexOf("https://")>-1)){let t=chrome.extension.getURL("js/modules/inject_with_content.js");chrome.tabs.sendMessage(e.id,{greeting:"hello",receivedCounter:receivedCounter,sentCounter:sentCounter},(function(r){r?Helper.log("Already there"):Helper.loadFile(t,t=>{if(!t)throw Error("js empty while rendering");chrome.tabs.executeScript(e.id,{code:t})})}))}}).catch(e=>{console.log(e,"<===Get Error current Tab Info Bg")}),Helper.sendMsgToContentScript("fde-finish-googleAuth-popup",null,()=>{})},200)})),chrome.tabs.onUpdated.addListener((function(e,t,r){let n=r.url;if(("loading"==t.status||"complete"==t.status)&&(n.indexOf("fluvid.com")>-1&&r.url.indexOf("error=")>-1&&chrome.tabs.remove(e),n.indexOf("fluvid.com")>-1&&r.url.indexOf("access_token=")>-1)){let t;n.indexOf("state=fb")>-1?(t=n.split("#access_token=")[1].split("&")[0],se(t,"fb"),chrome.tabs.remove(e)):n.indexOf("state=yt")>-1?(t=n.split("&access_token=")[1].split("&")[0],se(t,"yt"),chrome.tabs.remove(e)):n.indexOf("state=outlook")>-1&&(t=n.split("#access_token=")[1].split("&")[0],se(t,"ot"),chrome.tabs.remove(e))}"complete"==t.status&&t.url&&C.flag&&(m=0,Helper.broadcastToAllTabs("ping",{},()=>{}),Helper.sendMsgToContentScript("bg_plan_details",{plans:v},()=>{}),Helper.sendMsgToContentScript("bg_tab_change",{data:2},()=>{}))})),chrome.runtime.onInstalled.addListener((function(e){"install"===e.reason&&chrome.tabs.query({url:["http://*/*","https://*/*"]},(function(e){let t=chrome.extension.getURL("template/onboard.html");if(e&&e.length>0){let r=0;e.forEach(n=>{r++;let o=chrome.extension.getURL("js/modules/inject_with_content.js");Helper.loadFile(o,e=>{if(!e)throw Error("js empty while rendering");chrome.tabs.executeScript(n.id,{code:e})}),r===e.length&&setTimeout(()=>{window.open(t,"_blank")},500)})}else window.open(t,"_blank")}))})),chrome.runtime.onMessageExternal.addListener((function(e,t,n){if(e.message){if("vcc-version"===e.message){const e=chrome.runtime.getManifest();n({type:"success",version:e.version})}if("vcc-extension-login"===e.message)if(C.isLoggedIn){let e=localStorage.getItem("live_user_token"),t=Helper.getKeyValue("live_user_profile");chrome.tabs.query({currentWindow:!0,active:!0},(function(r){e&&r[0]&&r[0].url&&r[0].url.indexOf("fluvid.com")>-1?(d=!1,n({type:"success",token:e,userProfileData:t})):n({type:"error-url-fishing"})}))}else n({type:"fail"});"vcc-dashboard-login"===e.message?chrome.tabs.query({currentWindow:!0,active:!0},(function(t){if(!localStorage.getItem("live_user_token")&&e.token&&t[0]&&t[0].url&&t[0].url.indexOf("fluvid.com")>-1){d=!1,localStorage.getItem("live_user_token")||(localStorage.setItem("live_user_token",e.token),Helper.setKeyValue("live_user_profile",JSON.stringify(e.profile)),G())}})):"vcc-dashboard-logout"===e.message&&chrome.tabs.query({currentWindow:!0,active:!0},(function(e){e[0].url.indexOf("fluvid.com")>-1&&(d=!1,localStorage.removeItem("live_user_token"),localStorage.removeItem("live_user_profile"),G())})),"vcc-button-clicked"===e.message?(Helper.sendMsgToContentScript("vcc-open-extension-web",{liveTabStatus:0},()=>{}),setTimeout(()=>{Helper.sendMsgToMain("bg-click-offlive",null,()=>{})},500)):"vcc-force-save-video"===e.message&&(sentCounter>0&&receivedCounter<=sentCounter?X():(n({type:"force-video-fail"}),V(),receivedCounter=0,sentCounter=0)),"vcc-get-chunks"===e.message&&e.videoId.path==u&&(receivedCounter>0&&sentCounter>0&&r&&2==g?n({type:"fail-retry",receivedCounter:receivedCounter,sentCounter:sentCounter}):r&&0!=receivedCounter&&0!=sentCounter||0!=g?1==g?(n({type:"success",receivedCounter:receivedCounter,sentCounter:sentCounter}),receivedCounter=0,sentCounter=0):(n({type:"loading",receivedCounter:receivedCounter,sentCounter:sentCounter}),g=0):(n({type:"fail",receivedCounter:receivedCounter,sentCounter:sentCounter}),g=0,receivedCounter=0,sentCounter=0)),"vcc-get-chunks"===e.message&&e.videoId!=u&&n({type:"fishing",receivedCounter:receivedCounter,sentCounter:sentCounter}),"vcc-finish-streaming"===e.message&&Helper.sendMsgToContentScript("vcc-finish-stream",()=>{})}if(e&&e.data&&"vcc-stream-name"===e.data.message){if(_=e.data,p=!0,3==e.data.type||4==e.data.type||5==e.data.type){let t=e.data.stream_details;e.data.stream_details&&(S=t.fps,videoResolution=t.resolution)}Helper.sendMsgToContentScript("vcc-open-extension-web",{liveTabStatus:1},()=>{}),setTimeout(()=>{Helper.sendMsgToMain("bg-click-onlive",e,()=>{})},500)}}));let le=()=>{chrome.extension.getViews({type:"popup"}).length},de=()=>{var e=chrome.extension.getViews({type:"popup"});e.length&&e[0].open()};return chrome.runtime.onConnect.addListener((function(e){Helper.log("PopUp Opened");chrome.runtime.lastError;C.flag||Helper.getCurrentTabInfo().then(e=>{!e||-1===e.url.indexOf("http:")&&-1===e.url.indexOf("https:")||chrome.tabs.sendMessage(e.id,{greeting:"hello",receivedCounter:receivedCounter,sentCounter:sentCounter},(function(t){if(t)Helper.log("Already there");else{Helper.log("Not there, inject contentscript111");let t=chrome.extension.getURL("js/modules/inject_with_content.js");Helper.loadFile(t,t=>{if(!t)throw Error("js empty while rendering");Helper.log("inject_with_content File Exceuted"),chrome.tabs.executeScript(e.id,{code:t})})}}))}).catch(()=>{Helper.log("Tab Info Not Found")})})),chrome.tabs.onRemoved.addListener((function(e,t){let r=Helper.getKeyValue("activeTab");r&&(r=Helper.parseJSON(r),r&&r.tabId>0&&r.windowId>0&&e==r.tabId&&t.windowId==r.windowId?oe():Helper.log("Condtion false"))})),chrome.windows.onRemoved.addListener((function(e){let t=JSON.parse(Helper.getKeyValue("activeWindow"));t&&t&&t.windowId>0&&e==t.windowId&&Z(),H()})),chrome.runtime.setUninstallURL("https://docs.google.com/forms/d/1AUWvMpkAa9D-OdcuEHWbA4M019FXUMs2Clej3Wl9zGE"),{startRecording:U,stopRecording:B,resumeRecording:q,pauseRecording:D,cancelRecordingOnServer:Z,taskManager:ae,test:()=>{Helper.log("test node called")},verifyToken:G}}();